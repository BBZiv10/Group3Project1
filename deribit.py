# This python module calls deribit API to extract bitcoin derivative data for all instruments
# Import required libraries
import asyncio
import websockets
import json
import pandas as pd
import datetime as dt
from pathlib import Path

# Define the function for calling API
async def call_api(msg):
   async with websockets.connect('wss://test.deribit.com/ws/api/v2') as websocket:
       await websocket.send(msg)
       while websocket.open:
           response = await websocket.recv()
           return response
def async_loop(api, message):
    return asyncio.get_event_loop().run_until_complete(api(message))

# Define the function and set parameters for calling the API to retrieve data 
def retrieve_historic_data(start, end, instrument, timeframe):
    msg = \
        {
            "jsonrpc": "2.0",
            "id": 833,
            "method": "public/get_tradingview_chart_data",
            "params": {
                "instrument_name": instrument,
                "start_timestamp": start,
                "end_timestamp": end,
                "resolution": timeframe
            }
        }
    resp = async_loop(call_api, json.dumps(msg))
    return resp

# Define the function to convert API response in JSON to Pnadas DataFrame
def json_to_dataframe(json_resp):
    res = json.loads(json_resp)
    df = pd.DataFrame(res['result'])
    df['ticks'] = df.ticks / 1000
    df['timestamp'] = [dt.datetime.fromtimestamp(date) for date in df.ticks]
    return df

# Set the data range
start = 0
end = 1623088936000

# Form the list with unique instruments
instrument = ['BTC-2JUL21-42000-C', 'BTC-24SEP21-40000-P', 'BTC-18JUN21-25000-C', 'BTC-25JUN21-28000-P', 'BTC-25JUN21-68000-P', 'BTC-31DEC21-50000-P', 'BTC-31DEC21-48000-P', 'BTC-25JUN21-14000-P', 'BTC-18JUN21-60000-P', 'BTC-18JUN21-46000-C', 'BTC-12JUN21-44000-C', 'BTC-25JUN21-30000-C', 'BTC-12JUN21-36000-P', 'BTC-30JUL21-25000-P', 'BTC-11JUN21-36000-P', 'BTC-18JUN21-33000-P', 'BTC-2JUL21-50000-P', 'BTC-25MAR22-400000-C', 'BTC-11JUN21-40000-P', 'BTC-18JUN21-20000-P', 'BTC-12JUN21-39000-P', 'BTC-25JUN21-50000-C', 'BTC-11JUN21-70000-C', 'BTC-2JUL21-42000-P', 'BTC-18JUN21-31000-P', 'BTC-25JUN21-24000-C', 'BTC-11JUN21-26000-P', 'BTC-2JUL21-40000-P', 'BTC-31DEC21-28000-P', 'BTC-24SEP21-64000-P', 'BTC-24SEP21-32000-C', 'BTC-18JUN21-33000-C', 'BTC-11JUN21-37000-C', 'BTC-18JUN21-60000-C', 'BTC-30JUL21-45000-P', 'BTC-25JUN21-60000-P', 'BTC-11JUN21-48000-P', 'BTC-18JUN21-32000-C', 'BTC-11JUN21-39000-P', 'BTC-11JUN21-38000-P', 'BTC-30JUL21-60000-C', 'BTC-25JUN21-22000-P', 'BTC-2JUL21-34000-C', 'BTC-25JUN21-10000-P', 'BTC-25JUN21-14000-C', 'BTC-31DEC21-40000-C', 'BTC-2JUL21-36000-P', 'BTC-11JUN21-44000-P', 'BTC-30JUL21-28000-C', 'BTC-25JUN21-80000-C', 'BTC-31DEC21-26000-C', 'BTC-12JUN21-41000-P', 'BTC-31DEC21-120000-P', 'BTC-18JUN21-30000-P', 'BTC-31DEC21-300000-P', 'BTC-2JUL21-44000-C', 'BTC-2JUL21-30000-C', 'BTC-25JUN21-20000-P', 'BTC-25MAR22-300000-C', 'BTC-18JUN21-38000-C', 'BTC-30JUL21-65000-P', 'BTC-30JUL21-35000-C', 'BTC-25JUN21-44000-P', 'BTC-31DEC21-60000-P', 'BTC-12JUN21-38000-C', 'BTC-24SEP21-36000-P', 'BTC-27AUG21-80000-P', 'BTC-25JUN21-16000-C', 'BTC-11JUN21-31000-C', 'BTC-25MAR22-20000-C', 'BTC-11JUN21-20000-C', 'BTC-30JUL21-50000-C', 'BTC-27AUG21-90000-P', 'BTC-18JUN21-35000-C', 'BTC-31DEC21-30000-P', 'BTC-31DEC21-400000-P', 'BTC-11JUN21-55000-C', 'BTC-18JUN21-45000-P', 'BTC-31DEC21-200000-C', 'BTC-31DEC21-80000-C', 'BTC-18JUN21-35000-P', 'BTC-25JUN21-60000-C', 'BTC-25JUN21-48000-C', 'BTC-2JUL21-20000-P', 'BTC-11JUN21-34000-P', 'BTC-25JUN21-34000-C', 'BTC-18JUN21-37000-P', 'BTC-25JUN21-72000-P', 'BTC-31DEC21-160000-C', 'BTC-25JUN21-18000-C', 'BTC-30JUL21-90000-C', 'BTC-11JUN21-35000-P', 'BTC-18JUN21-55000-P', 'BTC-11JUN21-40000-C', 'BTC-18JUN21-55000-C', 'BTC-2JUL21-25000-C', 'BTC-11JUN21-37000-P', 'BTC-12JUN21-38000-P', 'BTC-12JUN21-33000-P', 'BTC-25MAR22-40000-P', 'BTC-27AUG21-40000-C', 'BTC-24SEP21-30000-C', 'BTC-11JUN21-33000-P', 'BTC-2JUL21-40000-C', 'BTC-30JUL21-28000-P', 'BTC-12JUN21-36000-C', 'BTC-24SEP21-28000-C', 'BTC-2JUL21-55000-P', 'BTC-27AUG21-70000-P', 'BTC-24SEP21-40000-C', 'BTC-25MAR22-80000-C', 'BTC-25MAR22-120000-C', 'BTC-31DEC21-60000-C', 'BTC-11JUN21-50000-C', 'BTC-27AUG21-45000-P', 'BTC-30JUL21-55000-C', 'BTC-24SEP21-30000-P', 'BTC-25MAR22-35000-P', 'BTC-18JUN21-31000-C', 'BTC-25MAR22-120000-P', 'BTC-27AUG21-35000-C', 'BTC-24SEP21-50000-P', 'BTC-31DEC21-300000-C', 'BTC-18JUN21-39000-C', 'BTC-31DEC21-24000-P', 'BTC-24SEP21-18000-P', 'BTC-25JUN21-56000-P', 'BTC-24SEP21-48000-P', 'BTC-31DEC21-12000-C', 'BTC-18JUN21-28000-P', 'BTC-12JUN21-40000-P', 'BTC-2JUL21-45000-C', 'BTC-24SEP21-64000-C', 'BTC-2JUL21-45000-P', 'BTC-18JUN21-65000-P', 'BTC-18JUN21-48000-P', 'BTC-25JUN21-64000-P', 'BTC-18JUN21-36000-P', 'BTC-24SEP21-20000-P', 'BTC-25MAR22-15000-C', 'BTC-24SEP21-8000-P', 'BTC-30JUL21-30000-P', 'BTC-30JUL21-100000-P', 'BTC-2JUL21-36000-C', 'BTC-2JUL21-34000-P', 'BTC-18JUN21-48000-C', 'BTC-24SEP21-8000-C', 'BTC-2JUL21-28000-C', 'BTC-30JUL21-45000-C', 'BTC-12JUN21-35000-P', 'BTC-25JUN21-76000-P', 'BTC-11JUN21-39000-C', 'BTC-25JUN21-68000-C', 'BTC-25MAR22-200000-C', 'BTC-24SEP21-72000-P', 'BTC-25MAR22-25000-C', 'BTC-31DEC21-100000-P', 'BTC-2JUL21-55000-C', 'BTC-31DEC21-160000-P', 'BTC-12JUN21-32000-C', 'BTC-25JUN21-140000-C', 'BTC-24SEP21-80000-P', 'BTC-31DEC21-20000-C', 'BTC-18JUN21-50000-C', 'BTC-2JUL21-50000-C', 'BTC-31DEC21-80000-P', 'BTC-25JUN21-34000-P', 'BTC-24SEP21-120000-C', 'BTC-25MAR22-30000-P', 'BTC-30JUL21-60000-P', 'BTC-24SEP21-200000-P', 'BTC-24SEP21-60000-P', 'BTC-24SEP21-12000-C', 'BTC-25JUN21-6000-P', 'BTC-27AUG21-40000-P', 'BTC-27AUG21-25000-P', 'BTC-18JUN21-38000-P', 'BTC-2JUL21-60000-C', 'BTC-25JUN21-64000-C', 'BTC-2JUL21-38000-P', 'BTC-25MAR22-250000-P', 'BTC-18JUN21-40000-P', 'BTC-11JUN21-70000-P', 'BTC-31DEC21-120000-C', 'BTC-31DEC21-28000-C', 'BTC-11JUN21-26000-C', 'BTC-31DEC21-40000-P', 'BTC-18JUN21-25000-P', 'BTC-30JUL21-50000-P', 'BTC-27AUG21-80000-C', 'BTC-27AUG21-25000-C', 'BTC-24SEP21-32000-P', 'BTC-18JUN21-65000-C', 'BTC-25MAR22-70000-C', 'BTC-25JUN21-8000-P', 'BTC-25JUN21-8000-C', 'BTC-11JUN21-32000-C', 'BTC-31DEC21-64000-C', 'BTC-2JUL21-20000-C', 'BTC-18JUN21-42000-C', 'BTC-24SEP21-100000-C', 'BTC-25JUN21-38000-P', 'BTC-18JUN21-42000-P', 'BTC-12JUN21-34000-C', 'BTC-30JUL21-15000-C', 'BTC-11JUN21-42000-C', 'BTC-11JUN21-31000-P', 'BTC-27AUG21-70000-C', 'BTC-2JUL21-60000-P', 'BTC-24SEP21-56000-C', 'BTC-12JUN21-34000-P', 'BTC-24SEP21-160000-C', 'BTC-25JUN21-36000-P', 'BTC-25JUN21-56000-C', 'BTC-25JUN21-38000-C', 'BTC-27AUG21-50000-P', 'BTC-31DEC21-16000-C', 'BTC-25JUN21-10000-C', 'BTC-11JUN21-60000-P', 'BTC-11JUN21-44000-C', 'BTC-25JUN21-16000-P', 'BTC-31DEC21-22000-C', 'BTC-18JUN21-44000-P', 'BTC-12JUN21-33000-C', 'BTC-25JUN21-36000-C', 'BTC-25JUN21-52000-P', 'BTC-24SEP21-16000-C', 'BTC-12JUN21-35000-C', 'BTC-12JUN21-42000-C', 'BTC-11JUN21-48000-C', 'BTC-25MAR22-30000-C', 'BTC-24SEP21-120000-P', 'BTC-18JUN21-34000-C', 'BTC-31DEC21-30000-C', 'BTC-11JUN21-28000-C', 'BTC-31DEC21-18000-P', 'BTC-25JUN21-40000-C', 'BTC-11JUN21-30000-C', 'BTC-24SEP21-26000-P', 'BTC-25JUN21-80000-P', 'BTC-30JUL21-36000-P', 'BTC-31DEC21-200000-P', 'BTC-2JUL21-32000-P', 'BTC-24SEP21-24000-C', 'BTC-25JUN21-88000-C', 'BTC-31DEC21-50000-C', 'BTC-25JUN21-32000-P', 'BTC-25JUN21-72000-C', 'BTC-25MAR22-70000-P', 'BTC-25JUN21-28000-C', 'BTC-12JUN21-40000-C', 'BTC-25JUN21-44000-C', 'BTC-27AUG21-35000-P', 'BTC-30JUL21-25000-C', 'BTC-11JUN21-25000-C', 'BTC-11JUN21-33000-C', 'BTC-25MAR22-400000-P', 'BTC-25JUN21-160000-P', 'BTC-27AUG21-45000-C', 'BTC-24SEP21-80000-C', 'BTC-25MAR22-200000-P', 'BTC-31DEC21-22000-P', 'BTC-18JUN21-28000-C', 'BTC-25MAR22-50000-P', 'BTC-31DEC21-12000-P', 'BTC-25JUN21-6000-C', 'BTC-31DEC21-24000-C', 'BTC-30JUL21-55000-P', 'BTC-25JUN21-18000-P', 'BTC-11JUN21-28000-P', 'BTC-12JUN21-37000-P', 'BTC-25JUN21-100000-C', 'BTC-27AUG21-15000-P', 'BTC-24SEP21-50000-C', 'BTC-24SEP21-28000-P', 'BTC-12JUN21-41000-C', 'BTC-25JUN21-160000-C', 'BTC-18JUN21-32000-P', 'BTC-11JUN21-42000-P', 'BTC-25JUN21-20000-C', 'BTC-24SEP21-20000-C', 'BTC-25MAR22-150000-P', 'BTC-18JUN21-46000-P', 'BTC-27AUG21-50000-C', 'BTC-25MAR22-100000-P', 'BTC-25JUN21-24000-P', 'BTC-24SEP21-72000-C', 'BTC-24SEP21-200000-C', 'BTC-31DEC21-18000-C', 'BTC-25MAR22-60000-P', 'BTC-18JUN21-45000-C', 'BTC-30JUL21-35000-P', 'BTC-31DEC21-32000-P', 'BTC-12JUN21-42000-P', 'BTC-25MAR22-20000-P', 'BTC-2JUL21-32000-C', 'BTC-18JUN21-39000-P', 'BTC-25JUN21-50000-P', 'BTC-27AUG21-60000-P', 'BTC-11JUN21-65000-P', 'BTC-30JUL21-32000-C', 'BTC-25MAR22-50000-C', 'BTC-27AUG21-60000-C', 'BTC-25JUN21-22000-C', 'BTC-31DEC21-16000-P', 'BTC-24SEP21-140000-P', 'BTC-25MAR22-60000-C', 'BTC-27AUG21-20000-P', 'BTC-24SEP21-26000-C', 'BTC-2JUL21-38000-C', 'BTC-31DEC21-140000-C', 'BTC-18JUN21-37000-C', 'BTC-11JUN21-38000-C', 'BTC-24SEP21-48000-C', 'BTC-31DEC21-64000-P', 'BTC-18JUN21-30000-C', 'BTC-18JUN21-36000-C', 'BTC-12JUN21-44000-P', 'BTC-11JUN21-35000-C', 'BTC-25JUN21-120000-P', 'BTC-2JUL21-25000-P', 'BTC-24SEP21-100000-P', 'BTC-27AUG21-55000-P', 'BTC-30JUL21-40000-P', 'BTC-30JUL21-20000-C', 'BTC-30JUL21-32000-P', 'BTC-30JUL21-34000-P', 'BTC-24SEP21-24000-P', 'BTC-25JUN21-32000-C', 'BTC-11JUN21-60000-C', 'BTC-31DEC21-140000-P', 'BTC-12JUN21-39000-C', 'BTC-27AUG21-15000-C', 'BTC-27AUG21-20000-C', 'BTC-31DEC21-48000-C', 'BTC-24SEP21-16000-P', 'BTC-12JUN21-32000-P', 'BTC-25MAR22-15000-P', 'BTC-24SEP21-36000-C', 'BTC-30JUL21-30000-C', 'BTC-30JUL21-100000-C', 'BTC-25JUN21-100000-P', 'BTC-31DEC21-32000-C', 'BTC-25MAR22-25000-P', 'BTC-24SEP21-18000-C', 'BTC-31DEC21-36000-C', 'BTC-11JUN21-30000-P', 'BTC-30JUL21-70000-P', 'BTC-25JUN21-76000-C', 'BTC-25MAR22-80000-P', 'BTC-27AUG21-90000-C', 'BTC-18JUN21-40000-C', 'BTC-25JUN21-12000-P', 'BTC-25MAR22-40000-C', 'BTC-11JUN21-45000-C', 'BTC-30JUL21-65000-C', 'BTC-18JUN21-50000-P', 'BTC-31DEC21-36000-P', 'BTC-25JUN21-52000-C', 'BTC-18JUN21-44000-C', 'BTC-25MAR22-300000-P', 'BTC-24SEP21-160000-P', 'BTC-11JUN21-46000-P', 'BTC-25JUN21-140000-P', 'BTC-11JUN21-50000-P', 'BTC-24SEP21-60000-C', 'BTC-31DEC21-26000-P', 'BTC-25MAR22-250000-C', 'BTC-24SEP21-140000-C', 'BTC-30JUL21-34000-C', 'BTC-25JUN21-120000-C', 'BTC-25MAR22-150000-C', 'BTC-30JUL21-80000-P', 'BTC-30JUL21-70000-C', 'BTC-30JUL21-20000-P', 'BTC-31DEC21-20000-P', 'BTC-27AUG21-30000-P', 'BTC-11JUN21-32000-P', 'BTC-11JUN21-65000-C', 'BTC-30JUL21-36000-C', 'BTC-11JUN21-55000-P', 'BTC-31DEC21-400000-C', 'BTC-24SEP21-88000-C', 'BTC-25JUN21-48000-P', 'BTC-11JUN21-34000-C', 'BTC-30JUL21-80000-C', 'BTC-18JUN21-34000-P', 'BTC-30JUL21-90000-P', 'BTC-25JUN21-30000-P', 'BTC-30JUL21-40000-C', 'BTC-27AUG21-30000-C', 'BTC-31DEC21-100000-C', 'BTC-11JUN21-25000-P', 'BTC-24SEP21-88000-P', 'BTC-11JUN21-20000-P', 'BTC-27AUG21-55000-C', 'BTC-2JUL21-44000-P', 'BTC-30JUL21-15000-P', 'BTC-12JUN21-37000-C', 'BTC-11JUN21-46000-C', 'BTC-11JUN21-45000-P', 'BTC-25JUN21-12000-C', 'BTC-25JUN21-40000-P', 'BTC-25MAR22-35000-C', 'BTC-18JUN21-20000-C', 'BTC-25MAR22-100000-C', 'BTC-24SEP21-56000-P', 'BTC-2JUL21-28000-P', 'BTC-11JUN21-36000-C', 'BTC-2JUL21-30000-P', 'BTC-24SEP21-12000-P', 'BTC-25JUN21-88000-P', 'BTC-25JUN21-88000-P']

# Set the timeframe for daily close prices
timeframe = '1440'

# Close prices for all instruments will be retrieved by calling the API in a for loop till end of the "instrument" list is reached. 
# After each call, result will be concatenated with master DataFrame "master_df"
master_df = pd.DataFrame()
for ins in instrument:
    try:
        print(ins)
        json_resp = retrieve_historic_data(start, end, ins, timeframe)
        df = json_to_dataframe(json_resp)
        df["Instrument"] = ins
        master_df = pd.concat([master_df, df])
        print(master_df.tail(2))
        df = pd.DataFrame()
    except:
        print("Error with "+ ins)
        continue


# Finally write the master_df to a file for further processing
master_df.to_csv(r'C:\Users\tapas kumar roy\OneDrive\Desktop\class\project1\deribit_history.csv', index = False)